#!/bin/bash

## Description: Install TYPO3 v13 with the contexts extension
## Usage: install-v13
## Example: ddev install-v13

set -e

TYPO3_VERSION="^13.4"
INSTALL_DIR="/var/www/html/v13"
EXTENSION_DIR="/var/www/html"
SITE_IDENTIFIER="contexts"
SITE_BASE="https://v13.contexts.ddev.site/"

echo "=== Installing TYPO3 ${TYPO3_VERSION} ==="

# Check if already installed
if [ -f "${INSTALL_DIR}/composer.json" ] && [ -d "${INSTALL_DIR}/vendor" ]; then
    echo "TYPO3 v13 already installed. Use 'ddev composer update' in v13 directory to update."
    echo "Or remove ${INSTALL_DIR} contents and run this command again for fresh install."
    exit 0
fi

# Fix volume ownership (Docker volumes mount as root)
sudo chown "$(id -u):$(id -g)" "${INSTALL_DIR}"

# Clean up existing directory contents if any
rm -rf "${INSTALL_DIR}"/* "${INSTALL_DIR}"/.[!.]* 2>/dev/null || true

# Create TYPO3 project directly in the install directory
echo "Creating TYPO3 ${TYPO3_VERSION} project..."
composer create-project "typo3/cms-base-distribution:${TYPO3_VERSION}" "${INSTALL_DIR}" --no-interaction
cd "${INSTALL_DIR}"

# Add path repository for local extension with priority over Packagist
echo "Configuring local extension repository..."
composer config repositories.packagist.org false
composer config repositories.local path "${EXTENSION_DIR}"
composer config minimum-stability dev
composer config prefer-stable true

# Require the extension from local path
echo "Installing contexts extension..."
composer require "netresearch/contexts:*" --no-interaction

# Re-enable packagist for any other dependencies
composer config repositories.packagist.org composer https://repo.packagist.org

# Create necessary directories
mkdir -p public/typo3conf public/fileadmin public/uploads var/log var/cache config/system config/sites/${SITE_IDENTIFIER}

# Database configuration
DB_NAME="db_v13"
DB_USER="db"
DB_PASS="db"
DB_HOST="db"

# Create database if it doesn't exist
mysql -h "${DB_HOST}" -u root -proot -e "CREATE DATABASE IF NOT EXISTS ${DB_NAME}; GRANT ALL ON ${DB_NAME}.* TO '${DB_USER}'@'%';"

# Create AdditionalConfiguration.php with DDEV-specific settings
cat > config/system/additional.php << 'ADDITIONAL_CONFIG'
<?php
$GLOBALS['TYPO3_CONF_VARS']['DB']['Connections']['Default'] = [
    'charset' => 'utf8mb4',
    'driver' => 'mysqli',
    'host' => 'db',
    'port' => 3306,
    'dbname' => 'db_v13',
    'user' => 'db',
    'password' => 'db',
    'tableoptions' => [
        'charset' => 'utf8mb4',
        'collate' => 'utf8mb4_unicode_ci',
    ],
];

// Development settings
$GLOBALS['TYPO3_CONF_VARS']['BE']['debug'] = true;
$GLOBALS['TYPO3_CONF_VARS']['FE']['debug'] = true;
$GLOBALS['TYPO3_CONF_VARS']['SYS']['devIPmask'] = '*';
$GLOBALS['TYPO3_CONF_VARS']['SYS']['displayErrors'] = 1;
$GLOBALS['TYPO3_CONF_VARS']['SYS']['exceptionalErrors'] = E_ALL;
$GLOBALS['TYPO3_CONF_VARS']['SYS']['trustedHostsPattern'] = '.*';

// DDEV: Disable backend referrer enforcement for multi-site development
$GLOBALS['TYPO3_CONF_VARS']['SYS']['features']['security.backend.enforceReferrer'] = false;

// Caching - use database for development
$GLOBALS['TYPO3_CONF_VARS']['SYS']['caching']['cacheConfigurations']['hash']['backend'] = \TYPO3\CMS\Core\Cache\Backend\Typo3DatabaseBackend::class;

// Install tool password: 'password'
$GLOBALS['TYPO3_CONF_VARS']['BE']['installToolPassword'] = '$argon2i$v=19$m=65536,t=16,p=1$QnRJTjVGWjNaN2o4Y1BIMg$EQ0x8K6FUfLIkGv3F5k0t0ncj7pdBoZSEfjEGYlb7TA';

// Graphics
$GLOBALS['TYPO3_CONF_VARS']['GFX']['processor'] = 'ImageMagick';
$GLOBALS['TYPO3_CONF_VARS']['GFX']['processor_path'] = '/usr/bin/';

// Exclude demo context GET parameter from cacheHash
$GLOBALS['TYPO3_CONF_VARS']['FE']['cacheHash']['excludedParameters'][] = 'debug';
ADDITIONAL_CONFIG

# Setup TYPO3
echo "Setting up TYPO3..."
./vendor/bin/typo3 setup --driver=mysqli --host=db --port=3306 --dbname=db_v13 --username=db --password=db --admin-username=admin --admin-user-password='Joh316!!' --admin-email=admin@example.com --project-name="Contexts v13" --server-type=apache --no-interaction --force

# Set up extension
echo "Setting up contexts extension..."
./vendor/bin/typo3 extension:setup || true

# Create site configuration
echo "Creating site configuration..."
cat > config/sites/${SITE_IDENTIFIER}/config.yaml << SITE_CONFIG
base: /
rootPageId: 1
languages:
  -
    title: English
    enabled: true
    languageId: 0
    base: /
    locale: en_US.UTF-8
    navigationTitle: English
    flag: us
routes: []
errorHandling: []
SITE_CONFIG

# Create demo contexts and content
echo "Creating demo content..."
/var/www/html/.ddev/commands/web/create-demo-content db_v13

# Flush cache
echo "Flushing caches..."
./vendor/bin/typo3 cache:flush

echo ""
echo "=== TYPO3 v13 Installation Complete ==="
echo ""
echo "Frontend: ${SITE_BASE}"
echo "Backend:  ${SITE_BASE}typo3"
echo "Admin:    admin / Joh316!!"
echo "Install:  password"
echo ""
