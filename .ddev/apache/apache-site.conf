# TYPO3 Multi-Version Apache Configuration

# Default server for health checks (must come first to handle 127.0.0.1 requests)
<VirtualHost *:80>
    ServerName localhost
    ServerAlias 127.0.0.1

    # DDEV health check endpoints - use Unix socket
    <Location /phpstatus>
        SetHandler "proxy:unix:/run/php-fpm.sock|fcgi://localhost"
    </Location>

    # Redirect everything else to main site
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/phpstatus
    RewriteRule ^ https://contexts.ddev.site%{REQUEST_URI} [R=302,L]
</VirtualHost>

# Main site - Shows overview/index
<VirtualHost *:80>
    ServerName contexts.ddev.site
    DocumentRoot /var/www/html/public

    <Directory /var/www/html/public>
        AllowOverride All
        Require all granted
    </Directory>

    # Also handle health check on this vhost - use Unix socket
    <Location /phpstatus>
        SetHandler "proxy:unix:/run/php-fpm.sock|fcgi://localhost"
    </Location>

    ErrorLog ${APACHE_LOG_DIR}/main-error.log
    CustomLog ${APACHE_LOG_DIR}/main-access.log combined
</VirtualHost>

# TYPO3 v12 instance
<VirtualHost *:80>
    ServerName v12.contexts.ddev.site
    DocumentRoot /var/www/html/v12/public

    <Directory /var/www/html/v12/public>
        AllowOverride All
        Require all granted
    </Directory>

    SetEnv TYPO3_CONTEXT Development/v12

    ErrorLog ${APACHE_LOG_DIR}/v12-error.log
    CustomLog ${APACHE_LOG_DIR}/v12-access.log combined
</VirtualHost>

# TYPO3 v13 instance
<VirtualHost *:80>
    ServerName v13.contexts.ddev.site
    DocumentRoot /var/www/html/v13/public

    <Directory /var/www/html/v13/public>
        AllowOverride All
        Require all granted
    </Directory>

    SetEnv TYPO3_CONTEXT Development/v13

    ErrorLog ${APACHE_LOG_DIR}/v13-error.log
    CustomLog ${APACHE_LOG_DIR}/v13-access.log combined
</VirtualHost>

# Documentation
<VirtualHost *:80>
    ServerName docs.contexts.ddev.site
    DocumentRoot /var/www/html/Documentation-GENERATED-temp

    DirectoryIndex Index.html index.html

    <Directory /var/www/html/Documentation-GENERATED-temp>
        AllowOverride All
        Require all granted
        Options Indexes FollowSymLinks
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/docs-error.log
    CustomLog ${APACHE_LOG_DIR}/docs-access.log combined
</VirtualHost>
